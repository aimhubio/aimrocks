name: aimrocks packaging pipeline

on: workflow_dispatch

jobs:
  linux-dist:
    runs-on: ubuntu-latest
    name: Linux wheels build (using Docker)
    steps:
      - name: Install Docker & images
        run: |
          apt update && apt install -y docker.io
          sudo systemctl enable --now docker

      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Setup python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'
          architecture: x64

      - name: Build bdist wheels for manylinux1_x86_64
        run: |
         docker run --mount type=bind,source=$PWD,target=/opt/aimrocks quay.io/pypa/manylinux1_x86_64 bash -e /opt/aimrocks/docker/build-wheels.sh

      - name: Build bdist wheels for manylinux2010_x86_64
        run: |
         docker run --mount type=bind,source=$PWD,target=/opt/aimrocks quay.io/pypa/manylinux2010_x86_64 bash -e /opt/aimrocks/docker/build-wheels.sh

      - name: Build bdist wheels for manylinux_2_24_x86_64
        run: |
         docker run --mount type=bind,source=$PWD,target=/opt/aimrocks quay.io/pypa/manylinux_2_24_x86_64 bash -e /opt/aimrocks/docker/build-wheels.sh

      - name: Install dev dependencies
        run: |
          python -m pip install -r requirements.dev.txt

      - name: Publish wheels
        env:
          PYPI_PASSWORD: ${{ secrets.pypi_password }}
        run: |
          python -m twine upload -u __token__ -p "${PYPI_PASSWORD}" manylinux_dist/*

  macos-dist:
    runs-on: ${{matrix.os}}
    strategy:
      fail-fast: false
      matrix:
        python-version: [ '3.6', '3.7', '3.8', '3.9', '3.10' ]
        os: [ 'macos-latest' ]
    name: Python ${{ matrix.python-version }} on ${{ matrix.os }} build
    steps:
      - name: Install third party deps (macOS)
        if: runner.os == 'macOS'
        run: |
          # zlib
          curl http://www.zlib.net/zlib-1.2.11.tar.gz -o zlib-1.2.11.tar.gz
          tar -xzf zlib-1.2.11.tar.gz
          cd zlib-1.2.11/
          ./configure && make install
          cd ../
          rm -rf zlib-1.2.11 zlib-1.2.11.tar.gz

          # bzip2
          curl https://sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz -o bzip2-1.0.8.tar.gz
          tar -xzf bzip2-1.0.8.tar.gz
          cd bzip2-1.0.8/
          sudo make install
          cd ../
          rm -rf bzip2-1.0.8 bzip2-1.0.8.tar.gz

          # snappy
          curl -L https://github.com/google/snappy/archive/1.1.8.tar.gz -o snappy-1.1.8.tar.gz
          tar zxvf snappy-1.1.8.tar.gz
          cd snappy-1.1.8
          mkdir build
          cd build
          cmake CFLAGS="-fPIC" CXXFLAGS="fPIC" -DCMAKE_POSITION_INDEPENDENT_CODE=ON .. && make && make install
          cd ../..
          rm -rf snappy-1.1.8 snappy-1.1.8.tar.gz

          # rocksdb
          curl -L https://github.com/facebook/rocksdb/archive/6.28.fb.tar.gz -o rocksdb-6.28.fb.tar.gz
          tar zxvf rocksdb-6.28.fb.tar.gz
          cd rocksdb-6.28.fb
          make -j2 static_lib && strip -S librocksdb.a && make install-static

      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Setup python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64

      - name: Install dev dependencies
        run: |
          python -m pip install -r requirements.dev.txt

      - name: Build bdist wheel
        run: |
          python setup.py bdist_wheel -d dist

      - name: Test bdist
        run: |
          python -m pip install dist/*.whl
          python -m pytest tests
          python -m pip uninstall -y aimrocks

      - name: Publish wheel
        env:
          PYPI_PASSWORD: ${{ secrets.pypi_password }}
        run: |
          python -m twine upload -u __token__ -p "${PYPI_PASSWORD}" dist/*
